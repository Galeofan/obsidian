#### CHECK-диапазоны детей: по какому столбцу они заданы
SELECT
  child.relname AS partition_name,
  pg_get_constraintdef(con.oid, true) AS check_def
FROM pg_inherits i
JOIN pg_class child ON child.oid = i.inhrelid
JOIN pg_constraint con ON con.conrelid = child.oid AND con.contype = 'c'
WHERE i.inhparent = 'operations.master'::regclass
ORDER BY child.relname;

---
#### Топ "прожорливых таблиц"
```
hit означает что процессор читает из кэша много данных, read - чтение с диска.
Т.е. чем больше hit на таблице тем больше данных из неё "перемалывается" процессором.
Лечить ограничением партиций, если всё равно много hit то индексами
```

SELECT relname, heap_blks_hit, heap_blks_read, idx_blks_hit, idx_blks_read
FROM pg_statio_user_tables
WHERE  heap_blks_hit != 0
ORDER BY (heap_blks_hit) DESC
LIMIT 100;

---
#### Активные запросы
SELECT now() - query_start, pid, query FROM pg_stat_activity WHERE state != 'idle' ORDER BY 1 DESC;  -- Проверить все запросы, которые выполняются в данный момент
SELECT * FROM pg_stat_activity WHERE state = 'active'; -- Проверить активные запросы
SELECT pg_cancel_backend(59129); --Убить застрявший процесс

---
#### Активные запросы v2
SELECT now() - xact_start AS tx_age, pid, state, wait_event_type, wait_event,
       query, application_name, backend_type, usename
FROM pg_stat_activity
WHERE datname = current_database()
--AND pid IN (59129, 59200, 59257)
AND application_name = 'gates_sbp'
ORDER BY tx_age DESC;

---
#### Посмотреть локи
SELECT bl.pid AS waiter_pid, lk.pid AS blocker_pid, bl.locktype, bl.mode, bl.relation::regclass, bl.page, bl.tuple
FROM pg_locks bl
JOIN pg_locks lk
  ON bl.locktype = lk.locktype
 AND bl.DATABASE IS NOT DISTINCT FROM lk.DATABASE
 AND bl.relation IS NOT DISTINCT FROM lk.relation
 AND bl.page IS NOT DISTINCT FROM lk.page
 AND bl.tuple IS NOT DISTINCT FROM lk.tuple
 AND bl.virtualxid IS NOT DISTINCT FROM lk.virtualxid
 AND bl.transactionid IS NOT DISTINCT FROM lk.transactionid
 AND bl.classid IS NOT DISTINCT FROM lk.classid
 AND bl.objid IS NOT DISTINCT FROM lk.objid
 AND bl.objsubid IS NOT DISTINCT FROM lk.objsubid
WHERE bl.granted = false AND lk.granted = true;